<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Brain - Alarm & Kalendarz</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VoiceBrain">
    <meta name="description" content="Notatki gosowe z alarmem i kalendarzem.">

    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiVm9pY2VCcmFpbiIsInNob3J0X25hbWUiOiJWb2ljZUJyYWluIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwic2NvcGUiOiIvIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9AZm9ydGF3ZXNvbWUvZm9udGF3ZXNvbWUtZnJlZUA2L3N2Z3Mvc29saWQvbWljcm9waG9uZS5zdmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 800: '#1e293b', 900: '#0f172a', 750: '#252f40' },
                        indigo: { 500: '#6366f1' }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    
    <style>
        [x-cloak] { display: none !important; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        body { -webkit-tap-highlight-color: transparent; }
        .recording-wave {
            display: inline-block; width: 6px; height: 20px; margin: 0 2px;
            background-color: #6366f1; border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
        }
        .recording-wave:nth-child(2) { animation-delay: 0.1s; }
        .recording-wave:nth-child(3) { animation-delay: 0.2s; }
        @keyframes wave {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 25px; opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans antialiased min-h-screen flex flex-col relative" x-data="voiceJournal()" x-cloak>

    <!-- EKRAN ALARMU (MODAL) -->
    <div x-show="alarmActive" 
         class="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-6 transition-opacity duration-300"
         x-transition:enter="opacity-0" x-transition:enter-end="opacity-100"
         style="display: none;">
        
        <div class="absolute inset-0 bg-red-500/20 animate-pulse-fast pointer-events-none"></div>
        
        <div class="z-10 bg-slate-800 p-8 rounded-3xl shadow-2xl border-2 border-red-500 text-center w-full max-w-sm relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-red-500 rounded-full blur-3xl opacity-30"></div>
            <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-amber-500 rounded-full blur-3xl opacity-30"></div>

            <i class="fas fa-bell fa-4x text-red-500 mb-6 animate-ping-slow"></i>
            
            <h2 class="text-3xl font-bold text-white mb-2">Alarm!</h2>
            <p class="text-xl text-indigo-300 mb-8 font-medium" x-text="activeAlarmTitle"></p>
            
            <button @click="stopAlarm()" 
                    class="w-full bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-bold py-6 px-8 rounded-2xl text-xl shadow-[0_0_30px_rgba(220,38,38,0.6)] transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center">
                <i class="fas fa-stop-circle mr-3"></i> WYCZ
            </button>
        </div>
    </div>

    <!-- NAGWEK -->
    <header class="sticky top-0 z-40 bg-slate-900/95 backdrop-blur-sm p-4 border-b border-slate-800 shadow-md">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-bold tracking-wide text-indigo-400 flex items-center">
                    <i class="fas fa-microphone-alt mr-2"></i>Voice Brain
                </h1>
                
                <div class="flex items-center space-x-2">
                    <button @click="showReminders = !showReminders" class="relative text-slate-400 hover:text-amber-400 transition-colors p-2">
                        <i class="fas fa-bell"></i>
                        <span x-show="activeRemindersCount > 0" class="absolute -top-1 -right-1 bg-amber-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" x-text="activeRemindersCount"></span>
                    </button>
                    
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="text-slate-400 hover:text-white transition-colors p-2">
                            <i class="fas fa-cog"></i>
                        </button>
                        <div x-show="open" @click.outside="open = false" class="absolute right-0 top-full mt-2 w-56 bg-slate-800 rounded-lg shadow-xl border border-slate-700 z-50 overflow-hidden" style="display: none;">
                            <button @click="triggerTestAlarm(); open = false" class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-slate-700 transition-colors flex items-center">
                                <i class="fas fa-volume-up mr-2 w-5"></i> Test Alarmu (STOP)
                            </button>
                            <button @click="requestNotificationPermission(); open = false" class="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 transition-colors flex items-center">
                                <i class="fas fa-bell mr-2 w-5"></i> Wcz powiadomienia
                            </button>
                            <button @click="exportBackup(); open = false" class="w-full text-left px-4 py-3 text-sm text-slate-300 hover:bg-slate-700 transition-colors flex items-center">
                                <i class="fas fa-file-export mr-2 w-5"></i> Eksportuj kopi
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                <input type="text" x-model="searchQuery" placeholder="Szukaj notatek..." class="w-full bg-slate-800 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-slate-700">
            </div>
        </div>
    </header>

    <!-- PANEL PRZYPOMNIE -->
    <div x-show="showReminders" class="max-w-md mx-auto w-full px-4 pt-4" style="display: none;">
        <div class="bg-slate-800/80 border border-amber-500/30 rounded-xl p-4 backdrop-blur">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-amber-300"><i class="fas fa-bell mr-2"></i>Nadchodzce</h2>
                <button @click="showReminders = false"><i class="fas fa-times text-amber-400"></i></button>
            </div>
            <template x-if="upcomingReminders.length === 0">
                <p class="text-slate-400 text-sm text-center py-2">Brak aktywnych przypomnie</p>
            </template>
            <div class="space-y-2">
                <template x-for="reminder in upcomingReminders" :key="reminder.id">
                    <div class="bg-slate-900/50 rounded-lg p-3 flex justify-between items-center">
                        <div>
                            <p class="text-white text-sm font-medium" x-text="reminder.title"></p>
                            <p class="text-amber-400 text-xs" x-text="formatReminderTime(reminder.reminderDate)"></p>
                        </div>
                        <button @click="deleteReminder(reminder.id)" class="text-slate-500 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- LISTA NOTATEK -->
    <main class="max-w-md mx-auto p-4 space-y-6 flex-grow pb-36 w-full">
        <template x-if="!isLoading && filteredNotes.length === 0">
            <div class="text-center text-slate-600 mt-20">
                <i class="fas fa-feather-alt text-4xl mb-4 text-slate-700"></i>
                <p>Nacinij mikrofon, aby zacz.</p>
                <p class="text-xs text-amber-500 mt-4 max-w-xs mx-auto">
                     Wskaz贸wka: U偶yj przycisku <i class="far fa-calendar-plus"></i> przy notatce, aby doda przypomnienie do systemowego kalendarza telefonu. To zagwarantuje alarm!
                </p>
            </div>
        </template>

        <template x-for="group in groupedNotes" :key="group.title">
            <div class="space-y-3">
                <h2 class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1" x-text="group.title"></h2>
                <template x-for="note in group.notes" :key="note.id">
                    <div class="bg-slate-800 rounded-xl p-5 shadow-lg relative border border-slate-700/50">
                        
                        <!-- Badge Przypomnienia -->
                        <div x-show="note.hasReminder && !note.reminderCompleted" class="absolute -top-2 -right-2 bg-amber-500 text-white text-xs px-2 py-1 rounded-full flex items-center space-x-1 reminder-badge z-10">
                            <i class="fas fa-bell text-xs"></i>
                            <span x-text="formatReminderBadge(note.reminderDate)"></span>
                        </div>

                        <!-- Tytu i Data -->
                        <div class="mb-2 pr-8">
                            <h3 class="text-lg font-bold text-white leading-tight" x-text="note.title || 'Bez tytuu'"></h3>
                        </div>
                        <div class="text-xs text-indigo-400 font-medium mb-3 flex items-center justify-between">
                            <span><i class="far fa-clock mr-1"></i> <span x-text="formatTime(note.date)"></span></span>
                            
                            <!-- ACTIONS BAR -->
                            <div class="flex space-x-3">
                                <!-- Dodaj do Kalendarza (NOWO) -->
                                <button @click="addToCalendar(note)" class="text-emerald-400 hover:text-emerald-300" title="Dodaj do kalendarza Google">
                                    <i class="far fa-calendar-plus text-lg"></i>
                                </button>
                                <button @click="deleteNote(note.id)" class="text-slate-500 hover:text-red-400">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div x-show="editingNoteId !== note.id" @click="startEditing(note)" class="cursor-pointer">
                            <p class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap opacity-80" x-text="note.text"></p>
                        </div>

                        <div x-show="editingNoteId === note.id" class="mt-2">
                            <textarea x-model="editingText" class="w-full bg-slate-900/50 text-white rounded-lg p-3 border border-indigo-500/50 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-y text-sm" rows="3"></textarea>
                            <div class="flex justify-end space-x-3 mt-3">
                                <button @click="cancelEditing()" class="text-sm text-slate-400 hover:text-white px-3 py-1">Anuluj</button>
                                <button @click="saveEdit(note.id)" class="text-sm bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-1.5 rounded-full shadow-lg flex items-center">
                                    <i class="fas fa-save mr-2"></i> Zapisz
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <footer class="text-center py-6 text-slate-600 text-xs z-10 bg-slate-900 w-full">
        <span>Wykonanie Tomasz Wawrzak 2026 z asyst AI Gemini</span>
    </footer>

    <!-- Mikrofon -->
    <div class="fixed bottom-20 left-0 right-0 flex justify-center z-50 pointer-events-none">
        <button @click="toggleRecording()" 
            class="pointer-events-auto w-16 h-16 rounded-full shadow-2xl flex items-center justify-center text-2xl transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none"
            :class="isRecording ? 'bg-red-500 text-white animate-pulse' : 'bg-indigo-500 text-white hover:bg-indigo-600'">
            <i class="fas" :class="isRecording ? 'fa-stop' : 'fa-microphone'"></i>
        </button>
    </div>

    <!-- Overlay Nagrywania -->
    <div x-show="isRecording" class="fixed bottom-40 left-0 right-0 px-4 z-40 pointer-events-none" style="display: none;">
        <div class="max-w-md mx-auto bg-slate-800/95 backdrop-blur border border-indigo-500/30 p-4 rounded-2xl shadow-2xl text-center">
            <p class="text-indigo-300 text-sm mb-1 font-semibold animate-pulse">Nasuchiwanie...</p>
            <p class="text-white text-lg italic" x-text="currentTranscript || 'M贸w teraz...'"></p>
            <p x-show="detectedReminder" class="text-amber-400 text-xs mt-2"><i class="fas fa-bell mr-1"></i>Wykryto przypomnienie!</p>
        </div>
    </div>

    <script>
        let audioCtx;
        let alarmIntervalId = null; // Do zaptlania d藕wiku
        
        const db = new Dexie('VoiceBrainDB');
        db.version(3).stores({ notes: '++id, date, text, title, hasReminder, reminderDate, reminderCompleted' });

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // Pojedynczy ton
        function playTone(freq, type = 'triangle', duration = 0.5) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // Sekwencja alarmowa
        function playAlarmSequence() {
            playTone(880, 'square', 0.2); // Pi
            setTimeout(() => playTone(880, 'square', 0.2), 300); // Pi
            setTimeout(() => playTone(880, 'square', 0.6), 600); // Piii
            if (navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 500]);
        }

        document.addEventListener('alpine:init', () => {
            Alpine.data('voiceJournal', () => ({
                notes: [],
                searchQuery: '',
                isRecording: false,
                currentTranscript: '',
                isLoading: true,
                detectedReminder: false,
                showReminders: false,
                
                // Nowe zmienne dla alarmu
                alarmActive: false,
                activeAlarmTitle: '',
                activeAlarmId: null,

                editingNoteId: null,
                editingText: '',
                
                // Zmienne do deduplikacji
                lastSavedText: '',
                lastSavedTime: 0,

                async init() {
                    await db.open();
                    await this.loadNotes();
                    this.setupSpeechRecognition();
                    this.checkReminders(); // POPRAWIONO: wywoanie waciwej metody
                    if ("Notification" in window) Notification.requestPermission();
                },

                async loadNotes() {
                    this.notes = (await db.notes.toArray()).sort((a, b) => b.date - a.date);
                    this.isLoading = false;
                },

                // --- FUNKCJE ALARMU ---

                triggerTestAlarm() {
                    this.activeAlarmTitle = "Test Alarmu";
                    this.activeAlarmId = null;
                    this.startAlarmLoop();
                },

                startAlarmLoop() {
                    this.alarmActive = true;
                    // Graj natychmiast
                    playAlarmSequence();
                    // I powtarzaj co 2 sekundy
                    if (alarmIntervalId) clearInterval(alarmIntervalId);
                    alarmIntervalId = setInterval(() => {
                        playAlarmSequence();
                    }, 2000);
                },

                async stopAlarm() {
                    this.alarmActive = false;
                    if (alarmIntervalId) {
                        clearInterval(alarmIntervalId);
                        alarmIntervalId = null;
                    }
                    if (this.activeAlarmId) {
                        await db.notes.update(this.activeAlarmId, { reminderCompleted: true });
                        await this.loadNotes();
                    }
                    this.activeAlarmId = null;
                    this.activeAlarmTitle = '';
                },

                // --- INTEGRACJA Z KALENDARZEM ---

                addToCalendar(note) {
                    if (!note.hasReminder || !note.reminderDate) {
                        alert("Ta notatka nie ma ustawionej daty przypomnienia.");
                        return;
                    }
                    
                    const startDate = new Date(note.reminderDate);
                    const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // +1 godzina
                    
                    // Formatowanie daty do formatu Google: YYYYMMDDTHHMMSSZ
                    const formatGCal = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");
                    
                    const title = encodeURIComponent(note.title);
                    const details = encodeURIComponent(note.text + "\n\nUtworzono w Voice Brain");
                    const start = formatGCal(startDate);
                    const end = formatGCal(endDate);
                    
                    // Link do Google Calendar
                    const url = `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}`;
                    
                    window.open(url, '_blank');
                },

                // --- SPRAWDZANIE PRZYPOMNIE ---

                async checkReminders() {
                    const check = async () => {
                        const now = new Date();
                        const due = this.notes.filter(n => n.hasReminder && !n.reminderCompleted && new Date(n.reminderDate) <= now);
                        
                        if (due.length > 0) {
                            // Jeli znajdziemy przypomnienie, uruchamiamy alarm dla pierwszego
                            const r = due[0];
                            if (!this.alarmActive) { // Nie przerywaj jeli ju偶 dzwoni
                                this.activeAlarmTitle = r.title;
                                this.activeAlarmId = r.id;
                                this.startAlarmLoop();
                                
                                // Pr贸ba powiadomienia systemowego
                                if ("Notification" in window && Notification.permission === "granted") {
                                    new Notification(" " + r.title, { 
                                        body: "Kliknij, aby otworzy aplikacj i wyczy alarm.",
                                        tag: 'voice-brain' 
                                    });
                                }
                            }
                        }
                    };
                    
                    check();
                    setInterval(check, 5000); // Sprawdzaj co 5 sek
                },

                // --- RESZTA LOGIKI (BEZ ZMIAN) ---
                
                get filteredNotes() {
                    const q = this.searchQuery.toLowerCase();
                    return this.notes.filter(n => (n.title?.toLowerCase().includes(q)) || (n.text?.toLowerCase().includes(q)));
                },
                get groupedNotes() {
                    const groups = {};
                    const today = new Date().toDateString();
                    this.filteredNotes.forEach(note => {
                        const d = new Date(note.date).toDateString();
                        let title = d === today ? 'Dzisiaj' : new Date(note.date).toLocaleDateString('pl-PL');
                        if (!groups[title]) groups[title] = { title, notes: [] };
                        groups[title].notes.push(note);
                    });
                    return Object.values(groups);
                },
                get upcomingReminders() {
                    const now = new Date();
                    return this.notes.filter(n => n.hasReminder && !n.reminderCompleted && new Date(n.reminderDate) > now).slice(0, 10);
                },
                get activeRemindersCount() { return this.upcomingReminders.length; },

                parseReminderFromText(text) {
                    const lowerText = text.toLowerCase();
                    const patterns = [
                        { regex: /przypomnij\s+mi\s+(jutro|dzisiaj|dzi)\s+(o\s+)?(\d{1,2})(:\d{2})?/i, type: 'specific' },
                        { regex: /przypomnij\s+(jutro|dzisiaj|dzi)\s+(o\s+)?(\d{1,2})(:\d{2})?/i, type: 'specific' },
                        { regex: /za\s+(\d+)\s+(godzin|godzin|godziny|minut|minut|minuty)/i, type: 'relative' }
                    ];
                    for (const pattern of patterns) {
                        const m = lowerText.match(pattern.regex);
                        if (m) {
                            const d = this.calculateReminderDate(m, pattern.type);
                            if (d) return { hasReminder: true, reminderDate: d, cleanedText: text.replace(m[0], '').trim() || text };
                        }
                    }
                    return { hasReminder: false, cleanedText: text };
                },

                calculateReminderDate(match, type) {
                    const now = new Date();
                    let d = new Date();
                    if (type === 'specific') {
                        if (match[1] === 'jutro') d.setDate(d.getDate() + 1);
                        d.setHours(parseInt(match[3]), match[4] ? parseInt(match[4].substring(1)) : 0, 0, 0);
                    } else if (type === 'relative') {
                        const val = parseInt(match[1]);
                        const unit = match[2];
                        if (unit.includes('godzin')) d.setHours(d.getHours() + val);
                        else if (unit.includes('minut')) d.setMinutes(d.getMinutes() + val);
                    }
                    return d > now ? d : null;
                },

                async saveNote(text) {
                    if (!text?.trim()) return;
                    const reminder = this.parseReminderFromText(text);
                    const noteData = {
                        text: reminder.cleanedText.trim(),
                        title: text.trim().slice(0, 20) + (text.length > 20 ? '...' : ''),
                        date: new Date(),
                        hasReminder: reminder.hasReminder,
                        reminderDate: reminder.reminderDate,
                        reminderCompleted: false
                    };
                    await db.notes.add(noteData);
                    await this.loadNotes();
                },

                async deleteNote(id) {
                    if (confirm('Usun?')) { await db.notes.delete(id); await this.loadNotes(); }
                },
                async deleteReminder(id) {
                    await db.notes.update(id, { hasReminder: false, reminderCompleted: true });
                    await this.loadNotes();
                },

                // PRZYWRCONO PENE FUNKCJE EDYCJI
                startEditing(note) {
                    this.editingNoteId = note.id;
                    this.editingText = note.text;
                },
                
                cancelEditing() {
                    this.editingNoteId = null;
                    this.editingText = '';
                },

                async saveEdit(id) {
                    const title = this.editingText.trim().slice(0, 20) + (this.editingText.length > 20 ? '...' : '');
                    await db.notes.update(id, { text: this.editingText, title: title });
                    await this.loadNotes();
                    this.editingNoteId = null;
                },
                
                async exportBackup() {
                    const data = await db.notes.toArray();
                    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'backup.json'; a.click();
                },

                setupSpeechRecognition() {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    if (SR) {
                        this.recognition = new SR();
                        this.recognition.continuous = true;
                        this.recognition.interimResults = true;
                        this.recognition.lang = 'pl-PL';
                        
                        this.recognition.onstart = () => { 
                            this.isRecording = true; 
                            playTone(440, 'sine', 0.1); 
                        };
                        
                        this.recognition.onresult = (e) => {
                            // Iterujemy przez wyniki, kt贸re ulegy zmianie (e.resultIndex)
                            for (let i = e.resultIndex; i < e.results.length; ++i) {
                                const result = e.results[i];
                                this.currentTranscript = result[0].transcript;
                                
                                if (result.isFinal) {
                                    const text = result[0].transcript.trim();
                                    
                                    // Zabezpieczenie przed duplikatami (Ten sam tekst w cigu 3 sek)
                                    if (this.lastSavedText === text && (Date.now() - this.lastSavedTime < 3000)) {
                                        console.warn("Zignorowano duplikat:", text);
                                        continue;
                                    }

                                    if (this.parseReminderFromText(text).hasReminder) this.detectedReminder = true;
                                    this.saveNote(text);
                                    
                                    this.lastSavedText = text;
                                    this.lastSavedTime = Date.now();
                                }
                            }
                        };
                        
                        this.recognition.onend = () => {
                            this.isRecording = false; 
                            playTone(300, 'sine', 0.1);
                        };
                    }
                },
                toggleRecording() {
                    initAudio();
                    if (this.isRecording) this.recognition.stop();
                    else this.recognition.start();
                },
                formatTime(d) { return new Date(d).toLocaleTimeString('pl-PL', {hour:'2-digit', minute:'2-digit'}); },
                formatReminderTime(d) { return new Date(d).toLocaleString('pl-PL'); },
                formatReminderBadge(d) { return Math.ceil((new Date(d) - new Date()) / (1000 * 60 * 60)) + 'h'; }
            }));
        });
    </script>
</body>
</html>